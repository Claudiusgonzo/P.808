<!--
/*---------------------------------------------------------------------------------------------
*  Copyright (c) Microsoft Corporation. All rights reserved.
*  Licensed under the MIT License. See License.txt in the project root for license information.
*--------------------------------------------------------------------------------------------*/
@author: Babak Naderi
-->

<head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8">
</head>



<style type="text/css">
body{font-family:Tahoma,"Times New Roman", Times, serif;}

.table th, .table td {
     border-top: none !important;
}
.center {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 30%;
}

.baudio {margin:5px;}
.baudio .baudio_table{display: inline;}
.baudio .bn{margin:10px;}
.baudio td{text-align:center;}
.baudio .blabel{margin-top:50px;font-size: 70%;	color: #636363;}

.scale {font-size: 100%;}
.scale td { text-align: left; padding:0;}
.scale label { display:block;}
.scale .c { text-align: center;}
section {
	margin-bottom:15px;
	padding: 10px 10px;
	font-family: Verdana, Geneva, sans-serif;
	color:#333333;
	font-size:0.9em;
}
fieldset { padding: 10px; background:#fbfbfb; border-radius:5px; margin-bottom:5px; }
</style>

<script type="text/javascript">

/*
General configuration file:
 - cookieName: change it for each study, it will be used to monitor if the user has taken training, setup sections, and
 how many assignments they submitted to expose limits.
 - forceRetrainingInHours: every X hours force the user to take part in training (recommendation: 1hour)
 - showSetupEveryMinutes: show the setup section every X minutes (recommendation: 15 minutes)
 - questionUrls: URLs to clips to be appeared in the Rating section. Either hard-coded or placeholders.
 - trainingUrls: URLs to clips to be appeared in the Training section. Either hard-coded or placeholders.
 - knownQuestionInTrainingUrl: Training may contain a question with known answer which worker will be forced to give the
 correct answer to.
 - knownQuestionInTrainingAns: the answer that should be selected by worker
 - knownQuestionUrl: the rating section may contain a question with known answer. It will be used in combination of the
 Assignment Review Policy.
 - knownQuestionAns: the answer that we expect from worker
 - randomizeTrainingQuestions: boolean whether the questions in the training section should be randomized on loading time.
 - randomizeRatingQuestions: boolean whether the questions in the rating section should be randomized on loading time.
 - allowedMaxHITsInProject: How many HITs each worker is allowed to answer in this project
 - allowedMaxContinuesSessionDurationInMinutes: how log is the maximum continue session. A break of 10min will be forced

*/
var config ={
	cookieName:"itu_p808_test_4",
    forceRetrainingInHours:1,
    showSetupEveryMinutes:30,
    debug:"true",
    questionUrls: ["${Q0}","${Q1}","${Q2}","${Q3}","${Q4}","${Q5}","${Q6}","${Q7}","${Q8}","${Q9}","${TP}","${gold_clips}"],
    trainingUrls: ["https://audiosamplesp808.blob.core.windows.net/librivox/book_00166_chp_0016_reader_06671_3.wav",
		"https://audiosamplesp808.blob.core.windows.net/librivox/book_06204_chp_0005_reader_03422_2.wav",
		"https://audiosamplesp808.blob.core.windows.net/librivox/book_07495_chp_0004_reader_01747_1.wav",
		"https://audiosamplesp808.blob.core.windows.net/librivox/book_07790_chp_0007_reader_11722_6.wav",
		"https://p808.s3.amazonaws.com/tps/book_00255_chp_0011_reader_04471_8_excellent_short.wav"],

    knownQuestionInTrainingUrl:"https://p808.s3.amazonaws.com/tps/book_00255_chp_0011_reader_04471_8_excellent_short.wav",
    knownQuestionInTrainingAns: "5",
    knownQuestionUrl:"${TP}",
    knownQuestionAns: "${TP_ANS}",
    randomizeTrainingQuestions:"true",
    randomizeRatingQuestions:"true",
    allowedMaxHITsInProject:60,
	allowedMaxContinuesSessionDurationInMinutes:45
}
// if performing of this assignment is already counted
var hitCounterIncreased = false;

/*
Initializing the page: generate and hide sections depending to the cookies value
*/
$(function() {
    // disable logs if not debug
    if (!JSON.parse(config['debug'])){
        console.log = function() {};
    }

	generate_training_section();
	generate_rating_section();
	avoidAnsweringBeforeListeningThrough();
	cookie_debug_status="";

    // given cookie availability disable the training
    if (readCookie(config.cookieName+"_training")){
		$('.trainingFieldset').prop("disabled", true);
		$("#training").hide();
		$("#training :input").removeAttr("required");
		$('#instruction').collapse()
		cookie_debug_status=cookie_debug_status+"Train Exist*";
	}
    // given cookie availability disable the setup
    if (readCookie(config.cookieName+"_setup")){
		$('.setupFieldset').prop("disabled", true);
		$("#setup").hide();
		$("#setup :input").removeAttr("required");
		cookie_debug_status=cookie_debug_status+"Setup Exist*";
	}


	howManyHITsAnswered= Number(readCookie(config['cookieName']+"_counter"));
	if (howManyHITsAnswered >= config['allowedMaxHITsInProject'])
		disableTheHIT();
	hitCounterIncreased = false;
	cookie_debug_status=cookie_debug_status+"Counter:"+howManyHITsAnswered+"*";
	addBrowserInfo(cookie_debug_status);
});


/*
Store the following information in hidden input field which will be added to answerc.sv by AMT
userAgent, cookieEnabled, appVersion, platform, language, status of 3 cookies.
*/
function addBrowserInfo(debug){
	info="U_A:"+navigator.userAgent+";"+
		"CookieEnabled:"+navigator.cookieEnabled+";"+
		"AppV:"+navigator.appVersion+";"+
		"Platform:"+navigator.platform+";"+
		"LN:"+navigator.language+";"+
		"cookie_debug:"+debug+";";

	$('#browser_info').val(info);
	console.log(info);

}
//--------------- Utilities -----------------

/*
	Utility function to format strings
*/
String.prototype.format = String.prototype.f = function() {
    var s = this,
        i = arguments.length;
    while (i--) {
        s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
    }
    return s;
};

/*
	Utility: convert seconds to MM:SS
*/
String.prototype.toMMSS = function () {
    var sec_num = parseInt(this, 10); // don't forget the second param
    var minutes   = Math.floor(sec_num / 60);
    var seconds = sec_num - (minutes * 60);
    if (minutes < 10) {minutes = "0"+minutes;}
    if (seconds < 10) {seconds = "0"+seconds;}
    return minutes+':'+seconds;
}

/*
	Disable the HIS and show a proper message.
	- used when the maximum number of HITs in project is reached
*/
function disableTheHIT(){
	$("#training").hide();
	$("#setup").hide();
	$("#rating_section").hide();
	$("#Survey").hide();
	$("#thanks").hide();
	$("#max_allowed_HITs_reached").show();
}

/*
	Add a cookies with corresponding values
*/
function createCookie(name, value, minutes) {
    var expires;
    if (minutes) {
        var date = new Date();
        date.setTime(date.getTime() + (minutes * 60 * 1000));
        expires = "; expires=" + date.toGMTString();
    } else {
        expires = "";
    }
     document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) + expires + "; path=/";
}

/*
	Update the cookie which counts the number of Assignments performed by user. Increase it by "updateBy" value.
*/
function updateCounterCookie(name, updateBy){
	expiry_in_a_month= 30*24*60
	c = readCookie(name);
	if (c==null){
		createCookie(name, 1, expiry_in_a_month);
		return 1;
	}else{
	 	console.log(c);
	 	createCookie(name, Number(c)+updateBy, expiry_in_a_month);
	}
	return Number(c)+updateBy;
}

/*
	Return the value of cookie, or null
*/
function readCookie(name) {
    var nameEQ = encodeURIComponent(name) + "=";
    var cookies = document.cookie.split(';');
    for (var i = 0; i < cookies.length; i++) {
        var c = cookies[i];
        while (c.charAt(0) === ' ')
            c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0)
            return decodeURIComponent(c.substring(nameEQ.length, c.length));
    }
    return null;
}


/*
	Callback when "Next" in Rating section is clicked.
*/
function showNextQuestionInRatingSection(){
	id=$("#nav-tab-ul li.active").index();
	id=id+2;
	$('#nav-tab-ul li:nth-child('+id+') a').tab('show');
}

/*
	Callback when "Previous" in Rating section is clicked.
*/
function showPreviousQuestionInRatingSection(){
	id=$("#nav-tab-ul li.active").index();
	id=id;
	$('#nav-tab-ul li:nth-child('+id+') a').tab('show');
}

/*
	Callback when "Next" in Training section is clicked.
*/
function showNextQuestionInTrainingSection(){
	var count = $("#trainingTabs li").length;
	id=$("#trainingTabs li.active").index();
	if (id+1!=count){
		id=id+2;
		$('#trainingTabs li:nth-child('+id+') a').tab('show');
	}else{
		// last next is called
		setTimeout(function (){
			window.location.hash="navNextPre";
		},  50);
	}
}

/*
	Callback when "Previous" in Training section is clicked.
*/
function showPreviousQuestionInTrainingSection(){
	id=$("#trainingTabs li.active").index();
	id=id;
	$('#trainingTabs li:nth-child('+id+') a').tab('show');
}


var trainingStimulusPlayed;

/*
  If all training clips played until the end, add a cookie expiring after
  config.forceRetrainingInHours
*/
function playedAudioTraining(id){
	$('input[name="'+id+'"]').off('change');
	trainingQuestionNumber= id.substring(1);
	eval("trainingStimulusPlayed["+trainingQuestionNumber+"-1]=1;");
	console.log(trainingStimulusPlayed.reduce(getSum, 0))
	if (trainingStimulusPlayed.reduce(getSum, 0) ==  trainingStimulusPlayed.length){
		createCookie(config.cookieName+"_training","un_important",config['forceRetrainingInHours']*60);
	}
	if ($('span[id="'+id+'"]').attr("data-src") == config['knownQuestionInTrainingUrl']){
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', onValueChangeForTpQuestionInTraining);
	}
}

// help to calc the sum of elements in an array
function getSum(total, num) {
  return total + num;
}

//---------------- baudio.js -----------------
// All functions needed for custom audio playback
var audioElements=[];
function clickManager(event) {
	ae=event.data.ae;
	var id=event.data.id;
	if (ae.paused) {
		pauseAll();
		playAudio(ae);
	} else {
		pauseAudio(ae);
	}
};

function playAudio(audio){
	audio.play();
	var idT=audio.id;
	var id=idT.substring(6,idT.length);
	console.log(id);
	$("#baudio_s_"+id).removeClass("glyphicon-repeat");
	$("#baudio_s_"+id).removeClass("glyphicon-play");
	$("#baudio_s_"+id).addClass("glyphicon-pause");
	$("#baudio_"+id).addClass("btn-primary");
	$("#audio_n_play_"+id).val(parseInt($("#audio_n_play_"+id).val())+1);
}

function pauseAudio(audio){
	audio.pause();
	var idT=audio.id;
	var id=idT.substring(6,idT.length);
	$("#baudio_s_"+id).removeClass("glyphicon-pause");
	$("#baudio_"+id).removeClass("btn-primary");
	$("#baudio_s_"+id).addClass("glyphicon-play");
}

function pauseAll(){
	for (i = 0; i < audioElements.length; i++) {
		if (!audioElements[i].paused){
			pauseAudio(audioElements[i]);
		}
	}
}

function canPlay(event){
	var ae=this;
	var idText =this.id;
	var id=idText.substring(6,idText.length);
	$("#baudio_l_d_"+id).text(" / " + (ae.duration).toString().toMMSS());
	$("#baudio_"+id).removeClass("disabled");
}

function timeUpdate(){
	var ae=this;
	var idText =this.id;
	var id=idText.substring(6,idText.length);
	$("#baudio_l_c_"+id).text(ae.currentTime.toString().toMMSS());
}

function isended(){
	var ae=this;
	var idText =this.id;
	var id=idText.substring(6,idText.length);

	$("#baudio_s_"+id).removeClass("glyphicon-pause");
	$("#baudio_"+id).removeClass("btn-primary");
	$("#baudio_s_"+id).addClass("glyphicon-repeat");
	$("#audio_n_finish_"+id).val(parseInt($("#audio_n_finish_"+id).val())+1);
	if ($("#"+id).attr('data-onfinished')){
		window[$("#"+id).attr('data-onfinished')](id);
	}
}

// loading all baudio elements in the page
$(function() {
    $( ".baudio" ).each(function(){
		titleTextTemplate='<tr><td>{1}</td></tr>';
		insert='';
		title='';
		a='<audio id="audio_{0}" preload="true"><source src="{1}" type="audio/wav"> </audio>'+
		'<input type="hidden" id="audio_n_play_{0}" name="audio_n_play_{0}" value="0">'+
		'<input type="hidden" id="audio_n_finish_{0}" name="audio_n_finish_{0}" value="0">';
		if ($(this).attr('title')){
			insert=titleTextTemplate;
			title=$(this).attr('title');
		}

		t='<table class="baudio_table" border="0">'+insert+' <tr><td><button id="baudio_{0}" type="button" class="btn bn disabled"><span id ="baudio_s_{0}" class="glyphicon glyphicon-play"></span></button></td></tr><tr><td><span id="baudio_l_c_{0}" class="blabel" >00:00</span><span id="baudio_l_d_{0}" class="blabel" > / 00:00</span></td></tr></table>';
		src=$(this).attr('data-src');
		id=$(this).attr('id');

		$(this).append(a.f(id,src));
		$(this).append(t.f(id,title));
		var audioElement = document.getElementById("audio_"+id);
		//save for later
		audioElements.push(audioElement);
		$( "#baudio_"+id ).click({ae: audioElement, id: id},clickManager);
		$( "#baudio_"+id ).disabled=false;
		audioElement.addEventListener("canplay",canPlay.bind(audioElement),false);
		audioElement.addEventListener("timeupdate",timeUpdate.bind(audioElement),false);
		audioElement.addEventListener("ended",isended.bind(audioElement),false);
	});
});

/*
	Called when the scale item is clicked
*/
function alertForbiddenChange(){
	alert('You should listen until the end.');
	$(this).prop('checked', false);
}

/*
	Users should not be able to vot before listening the audio clips until the end.
*/
function avoidAnsweringBeforeListeningThrough(){
	var i;
	// Training section
	for (i = 0; i < config['trainingUrls'].length; i++) {
		$('input[name="t{0}"]'.f(i+1)).on('change', alertForbiddenChange);
	}
	// Rating section
	for (i = 0; i < config['questionUrls'].length; i++) {
		$('input[name="q{0}"]'.f(i+1)).on('change', alertForbiddenChange);
	}
}

/*
	Listener on value change for the trapping question.
	if the answer is correct, change the value of tp_check to 0.
*/
function onValueChangeForTpQuestion(){
	if ($( this ).val()  == parseInt(config['knownQuestionAns']))
		$('#tp_check').val(0);
	else
		$('#tp_check').val(-1);
}

/*
	Listener on value change for the trapping question in training.
	if the answer is wrong, show a message.
*/
function onValueChangeForTpQuestionInTraining(){
	if ($( this ).val()  != config['knownQuestionInTrainingAns']){
		alert('Error: In case you hear an interruption message, please follow the instruction given in the message.');
		$(this).prop('checked', false);
	}

}

/*
	Called when the audio in rating section by the given id is completely played.
	Now user can rate the quality.
*/
function playedAudioQ(id){
	// check if it was the trapping question
	if ($('span[id="'+id+'"]').attr("data-src") == config['knownQuestionUrl']){
		element = $('input[name="'+id+'"]');
		element.unbind();
		element.on('change', onValueChangeForTpQuestion);
	}else{
		$('input[name="'+id+'"]').off('change');
		// check if already this HIT is counted
		if (!hitCounterIncreased){
			updateCounterCookie(config['cookieName']+"_counter",1);
			hitCounterIncreased=true
		}
	}
}

/*
	Called when user answers to one question from setup
	(i.e. q2. math question). Here the cookie will be added/updated
*/
function userAnsweringToSetupQuestions(){
	createCookie(config.cookieName+"_setup","un_important",config['showSetupEveryMinutes']);
	$('input[name="math"]').off('change');
}

</script>

<script type="text/javascript">

/*
	functions responsible to headset check
*/
function isHeadsetOn(webrtc_raw){
	keywords= ["headphone",  "headset","airpod", "usb audio device"]
	for (var i = 0; i < keywords.length; i++) {
		if (webrtc_raw.includes(keywords[i]))
			return true;
	}
	return false;
}

const constraints = {
  	audio: true,
	video:false
};

/*
	Async function to check the list of audio devices when the user allowed
*/
const startHeadsetCheck = async function() {
	$('#status').html("waiting for allowance...")
    await navigator.mediaDevices.getUserMedia(constraints);

    navigator.mediaDevices.enumerateDevices()
    .then(devices => {
        var device_list= "";
        for (var i=0;i<devices.length;i++){
        	if (devices[i].kind.startsWith('audio')){
    			device_list = device_list+ devices[i].kind + ":" +devices[i].label.toLowerCase() +"+";
    		}
        }
        headsetDetected=isHeadsetOn(device_list);
        $( "#webrtc_raw" ).val(device_list);
        $( "#use_headset" ).val(headsetDetected);
		$( "#status" ).html("Done. Please continue.");
  });
}

//function startMeasure(){
// 	startHeadsetCheck();
//}
</script>

<script type="text/javascript">

/*
	shuffle function for randomization of items -->
*/
function shuffle(a) {
	var j, x, i;
	for (i = a.length - 1; i > 0; i--) {
		j = Math.floor(Math.random() * (i + 1));
		x = a[i];
		a[i] = a[j];
		a[j] = x;
	}
	return a;
}

/*
	Generate the training section
*/
function generate_training_section(){
	acr_nav_tab = '<li class="nav-item {1}"><a class="nav-link " data-toggle="tab"  href="#T{0}-panel" id="T{0}-tab " role="tab" aria-controls="T{0}" {2}>Q. {0}</a></li>';
	acr_tab ='<div class="tab-pane fade {2}" id="T{0}-panel" role="tabpanel" aria-labelledby="T{0}-tab"><p></p><div class="row">	<div class="col-sm-3"></div>	<div class="col-sm-6">		<p style="margin-top:10px;">{0}. How do you rate the <b>overall quality</b> of the following speech sample? </p><p align="center"> <span class="baudio" id="t{0}" data-onfinished="playedAudioTraining" data-src="{1}" >&nbsp;</span> </p><fieldset id="fieldset_t{0}" class="trainingFieldset" title=""><table class="table md scale" cellspacing="0" cellpadding="0">			<thead><tr><th >Quality of the speech</th><th class="c" >Score</th></tr>			</thead>			<tbody><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="5">Excellent</label></div></td><td class="c">5</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="4">Good</label></div></td><td class="c">4</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="3">Fair</label></div></td><td class="c">3</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="2">Poor</label></div></td><td class="c">2</td></tr><tr><td><div class="radio" ><label ><input type="radio" name="t{0}" value="1"required="">Bad</label></div></td><td class="c">1</td></tr>	   </tbody></table>		</fieldset><p></p> </div> 	<div class="col-sm-3"></div></div> <p></p> </div>';
	// this will show which url was shown by in which question as their orther will be randomized
	input_template= '<input id="T{0}_URL" name="T{0}_URL" type="hidden" value="{1}" />';

    if (JSON.parse(config['randomizeTrainingQuestions']))
		urls = shuffle(config['trainingUrls']);
	else
		urls = config['trainingUrls'];

	var i;
	for (i = 0; i < urls.length; i++) {
		if (i==0){
			$('#trainingTabs').append(acr_nav_tab.f(i+1,'active', 'ria-selected="true"'));
			$('#nav-tabContent').append(acr_tab.f(i+1, urls[i],'in active'));
		}else{
			$('#trainingTabs').append(acr_nav_tab.f(i+1,'',''));
			$('#nav-tabContent').append(acr_tab.f(i+1, urls[i],''));
		}
		$('#av-tabContent').append(input_template.f(i+1, urls[i]));
	}
	$('.question_number_training').html(urls.length);
	trainingStimulusPlayed = new Array(urls.length).fill(0);
}

/*
	Generate rating section
*/
function generate_rating_section(){
	acr_nav_tab = '<li class="nav-item {1}"><a class="nav-link" data-toggle="tab" href="#Q{0}-panel" id="Q{0}-tab" role="tab" aria-controls="Q{0}" {2}>Q. {0}</a></li>';
	acr_tab ='<div class="tab-pane fade {2}" id="Q{0}-panel" role="tabpanel" aria-labelledby="q{0}-tab"> <p></p> <div class="row"> <div class="col-sm-3"></div> <div class="col-sm-6"> <p style="margin-top:10px;">{0}. How do you rate the <b>overall quality</b> of the following speech sample? </p> <p align="center"> <span class="baudio" id="q{0}" data-onfinished="playedAudioQ" data-src="{1}" >&nbsp;</span> </p> <fieldset id="fieldset_q{0}" title=""> <table class="table md scale" cellspacing="0" cellpadding="0"> <thead> <tr><th >Quality of the speech</th><th class="c" >Score</th></tr> </thead> <tbody> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="5">Excellent</label></div></td><td class="c">5</td></tr> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="4">Good</label></div></td><td class="c">4</td></tr> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="3">Fair</label></div></td><td class="c">3</td></tr> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="2">Poor</label></div></td><td class="c">2</td></tr> <tr><td><div class="radio" ><label ><input type="radio" name="q{0}" value="1"required="">Bad</label></div></td><td class="c">1</td></tr> </tbody> </table> </fieldset> <p></p> </div> <div class="col-sm-3"></div> </div> <p></p> </div>';
	// this will show which url was shown by in which question as their orther will be randomized
	input_template= '<input id="Q{0}_URL" name="Q{0}_URL" type="hidden" value="{1}" />';
	if (JSON.parse(config['randomizeRatingQuestions'])){
		urls = shuffle(config['questionUrls']);
	}else{
		urls = config['questionUrls'];
	}

	var i;
	for (i = 0; i < urls.length; i++) {
		if (i==0){
			$('#nav-tab-ul').append(acr_nav_tab.f(i+1,'active', 'ria-selected="true"'));
			$('#nav-tabContent-rating').append(acr_tab.f(i+1, urls[i],'in active'));
		}else{
			$('#nav-tab-ul').append(acr_nav_tab.f(i+1,'',''));
			$('#nav-tabContent-rating').append(acr_tab.f(i+1, urls[i],''));
		}
		$('#nav-tabContent-rating').append(input_template.f(i+1,urls[i]));
	}
	$('.question_number').html(urls.length);

}
</script>

<!-- Instructions -->
<section class="container" id="Survey">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#instruction" data-toggle="collapse" >Instructions for speech quality assessment (Part 2 - Rating)</a>
			</h3>
		</div>
		<div  class="panel-collapse collapse in" id="instruction">
			  <div class="panel-body" >
			  <b>Introduction</b>

				<img src="https://p808.s3.amazonaws.com/assets/img/process_2.png" alt="scale" class="center" width="300px">

				  <p>Welcome and congratulation! You have been selected to participate in our speech quality assessment experiment! This HIT has two + one (just every one hour) sections::</p>
				<ul>
					<li><b>Setup:</b> Configure your system and validate it by answering to 6 questions</li>
					<li><b>Training (every one hour):</b> <b class="question_number_training"></b> questions, same as "Ratings" but appears just once a day</li>
					<li><b>Rating:</b> Listen to <b class="question_number"></b> audio files and give <b>your opinion about the quality of the speech</b> you hear.</li>
				</ul>
				<p>You should follow the below mentioned rules, otherwise your answers will be invalid.</p>
				<p><b>Rules:</b></p>
				<ul>
					<li>Use a headset, not the loudspeaker: otherwise your response will be rejected</li>
					<li>Perform the task in a quite environment</li>
					<li>Do not change the volume after modifying it in the Setup section.</li>
				</ul>

				<p><b>Payment:</b></p>
				<p>The result of this experiment is <b>very important for us and other scientist</b> working in this area. We have methods that analyse the consistency of your answers. We will use these methods to rank the submitted assignments according to quality.</p>
				<p>For this experiment, we will pay a base reward of <b>$0.50/HIT</b> for every accepted HIT. We have made available a set of 57 different HITs. You will receive a bonus of:</p>

				<ul>
				  <li>$0.10/HIT (for a total of <b>$0.60/HIT</b>) if you submit <b>more than 30 HITs</b> or</li>
				  <li>$0.25/HIT (for a total of <b>$0.75/HIT</b>) if you submit <b>more than 30 HITs</b> <u>and</u> be in the <b>top 20% quality group</b>.</li>
				</ul>

				<p>Bonuses will be assigned with in 7 days.</p>
				<b>Please perform up to <u>60 HITs</u> from this group.</b>
			</div>
		</div>

	</div>
</section>

<!-- Setup -->
<section class="container" id="setup">
<div class="panel panel-info">
  <div class="panel-heading">
    <h3 class="panel-title">
		<a data-target="#setup_panel" data-toggle="collapse" >Setup</a>
	</h3>
  </div>
  <div  class="panel-collapse collapse in" id="setup_panel">
	  <div class="panel-body">

		  <div style="text-align: center;margin:30px;"> <img src="https://p808.s3.amazonaws.com/assets/img/attention.png" alt="attention">  <b>Please wear your headphones now. You must <u>wear both earbuds</u>. </b></div>

		<fieldset class="setupFieldset" ><label>1.&nbsp;Please adjust the level of your computer to <b>a comfortable level</b> so that you hear the following audio sample very well.</label>

			<p align="center"> <span class="baudio" id="volume" data-src="https://p808.s3.amazonaws.com/assets/clips/signal_level.wav" >&nbsp;</span> </p>

			<div class="alert alert-danger" role="alert">
			  <b>NOTE:</b> Missing this step can strongly affect quality of your answer.
			</div>

			<div class="alert alert-warning" role="alert">
			  After adjusting the level, you are not allowed to change the volume anymore. Otherwise your response will be rejected.
			</div>
		</fieldset>


		<fieldset  class="setupFieldset"><label>2.&nbsp; Please listen to the following audio file and type in the answer to the question: </label>

				<div align="center"> <span class="baudio" id="math1" data-src="${math}" >&nbsp;</span> </div>


		<div align="center">Result: &nbsp; <input id="Math" name="Math" required="" size="10" type="text" onchange="userAnsweringToSetupQuestions()"/> </div>

		</fieldset>

		<div class="alert alert-info" role="alert">For the following <b>four questions</b>, please specify which sample has a better quality compared to the other one from your perspective.</div>


		<fieldset  class="setupFieldset"><label>3.&nbsp;Which sample has a better quality compared to the other one? </label>

		<div class="row" style="margin-top:10px;">
				<div class="col-sm-4">
					<div align="right"> <span class="baudio" id="CMP1_A" title="Sample A" data-src="${CMP1_A}" >&nbsp;</span> </div>
				</div>
				<div class="col-sm-4"></div>
				<div class="col-sm-4">
					<div align="left"> <span class="baudio" id="CMP1_B" title="Sample B" data-src="${CMP1_B}" >&nbsp;</span> </div>
				</div>
		</div>

		<div class="row" >
				<div class="col-sm-4"></div>
				<div class="col-sm-5">
					<div class="radio"><label><input type="radio" name="cmp1" required="" value="a">Quality of <b>Sample A</b> is better.</label></div>
					<div class="radio"><label><input type="radio" name="cmp1" required="" value="o">Difference is <b>not detectable</b>.</label></div>
					<div class="radio"><label><input type="radio" name="cmp1" required="" value="b">Quality of <b>Sample B</b> is better.</label></div>
				</div>
				<div class="col-sm-3"></div>
		</div>

		</fieldset>

		<fieldset  class="setupFieldset"><label>4.&nbsp;Which sample has a better quality compared to the other one? </label>

		<div class="row" style="margin-top:10px;">
				<div class="col-sm-4">
					<div align="right"> <span class="baudio" id="CMP2_A" title="Sample A" data-src="${CMP2_A}" >&nbsp;</span> </div>
				</div>
				<div class="col-sm-4"></div>
				<div class="col-sm-4">
					<div align="left"> <span class="baudio" id="CMP2_B" title="Sample B" data-src="${CMP2_B}" >&nbsp;</span> </div>
				</div>
		</div>

		<div class="row" >
				<div class="col-sm-4"></div>
				<div class="col-sm-5">
					<div class="radio"><label><input type="radio" name="cmp2" required="" value="a">Quality of <b>Sample A</b> is better.</label></div>
					<div class="radio"><label><input type="radio" name="cmp2" required="" value="o">Difference is <b>not detectable</b>.</label></div>
					<div class="radio"><label><input type="radio" name="cmp2" required="" value="b">Quality of <b>Sample B</b> is better.</label></div>
				</div>
				<div class="col-sm-3"></div>
		</div>

		</fieldset>
		<fieldset  class="setupFieldset"><label>5.&nbsp;Which sample has a better quality compared to the other one? </label>

		<div class="row" style="margin-top:10px;">
				<div class="col-sm-4">
					<div align="right"> <span class="baudio" id="CMP3_A" title="Sample A" data-src="${CMP3_A}" >&nbsp;</span> </div>
				</div>
				<div class="col-sm-4"></div>
				<div class="col-sm-4">
					<div align="left"> <span class="baudio" id="CMP3_B" title="Sample B" data-src="${CMP3_B}" >&nbsp;</span> </div>
				</div>
		</div>

		<div class="row">
				<div class="col-sm-4"></div>
				<div class="col-sm-5">
					<div class="radio"><label><input type="radio" name="cmp3" required="" value="a">Quality of <b>Sample A</b> is better.</label></div>
					<div class="radio"><label><input type="radio" name="cmp3" required="" value="o">Difference is <b>not detectable</b>.</label></div>
					<div class="radio"><label><input type="radio" name="cmp3" required="" value="b">Quality of <b>Sample B</b> is better.</label></div>
				</div>
				<div class="col-sm-3"></div>
		</div>

		</fieldset>

		<fieldset  class="setupFieldset"><label>6.&nbsp;Which sample has a better quality compared to the other one? </label>


		<div class="row" style="margin-top:10px;">
				<div class="col-sm-4">
					<div align="right"> <span class="baudio" id="CMP4_A" title="Sample A" data-src="${CMP4_A}" >&nbsp;</span> </div>
				</div>
				<div class="col-sm-4"></div>
				<div class="col-sm-4">
					<div align="left"> <span class="baudio" id="CMP4_B" title="Sample B" data-src="${CMP4_B}" >&nbsp;</span> </div>
				</div>
		</div>

		<div class="row">
				<div class="col-sm-4"></div>
				<div class="col-sm-5">
					<div class="radio"><label><input type="radio" name="cmp4" required="" value="a">Quality of <b>Sample A</b> is better.</label></div>
					<div class="radio"><label><input type="radio" name="cmp4" required="" value="o">Difference is <b>not detectable</b>.</label></div>
					<div class="radio"><label><input type="radio" name="cmp4" required="" value="b">Quality of <b>Sample B</b> is better.</label></div>
				</div>
				<div class="col-sm-3"></div>
		</div>

		</fieldset>

	  </div>
  </div>
</div>

</section>
<!-- Setup  ends-->

<!-- Device Check -->
<section class="container" id="device_check_section">
	<div class="panel panel-primary">
		<div class="panel-heading">
			<h3 class="panel-title">
				<a data-target="#device_check" data-toggle="collapse" >Listening device check</a>
			</h3>
		</div>
		<div  class="panel-collapse collapse in" id="device_check">
			  <div class="panel-body" >
			  <b>Introduction</b>
				  <p>We need to check your listening device. It is an automated test using your Web-browser functionality. Please click on <b>Start</b>.
					  After that, you might see a popup message from your browser asking for allowance to use your microphone.
					  Please click on <b>Allow</b> (on some of smartphones there will be no message).
				 <div class="center">
						<button type="button" class="btn btn-primary center" onclick="startHeadsetCheck()">Start</button>
						<div id="status"></div>
			  	</div>
			</div>
		</div>

	</div>
</section>
<!-- Device Check ends-->

<!-- Training section, appears once a day-->
<section class="container" id="training">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h3 class="panel-title">
					<a data-target="#trainingS" data-toggle="collapse" >Training (appears once in an hour)</a>
				</h3>
			</div>
			<div  class="panel-collapse collapse in" id="trainingS">
				<div class="panel-body">
				<p> Please answer the following <b class="question_number_training"></b> questions. For each question, please listen to the audio sample and give your opinion about the quality of the speech you hear on the following scale. <b>Note</b> that the scale will be activated when the speech sample played until the end. In case you hear an interruption message, please follow the instruction given in the message.</p>
				<p> There is no right or wrong answer as long as you listen to the audio files and give your opinion.</p>

 				<!-- will be generated -->
				<ul class="nav nav-tabs" role="tablist" id="trainingTabs">
				</ul>

				<div class="tab-content" id="nav-tabContent">


				</div>
			<div style="margin-top:0px;font-size:90%;text-align:center">Click <b>next</b> to answer all <b class="question_number_training"></b> questions.</div>
			<nav aria-label="..." id="navNextPreT">
			  <ul class="pager">
				<li class="previous" onclick="showPreviousQuestionInTrainingSection();"><a href="#trainingTabs" class="page-link"  role="button"><span aria-hidden="true">&larr;</span>Previous</a></li>
				<li class="next" onclick="showNextQuestionInTrainingSection();"><a href="#trainingTabs" class="page-link"  role="button">Next <span aria-hidden="true">&rarr;</span></a></li>
			  </ul>
			</nav>

			</div>
			</div>
		</div>

</section>
<!-- Training section ends-->

<input id="tp_check" name="tp_check" type="hidden" value="-1" />
<input id="browser_info" name="browser_info" type="hidden" value="-1" maxlength="2000"/>
<input id="webrtc_raw" name="webrtc_raw" type="hidden" value="-1" maxlength="2000"/>
<input id="use_headset" name="use_headset" type="hidden" value="-1" />

<!--- Rating task -->
<section class="container" id="rating_section">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h3 class="panel-title">Ratings</h3>
			</div>
			<div class="panel-body">
				<p> Please answer the following <b class="question_number"></b> questions. For each question, please listen to the audio sample and give your opinion about the quality of the speech you hear on the following scale. <b>Note</b> that the scale will be activated when the speech sample played until the end. In case you hear an interruption message, please follow the instruction given in the message.</p>
				<p> There is no right or wrong answer as long as you listen to the audio files and give your opinion.</p>

 				<!-- will be generated -->
				<ul class="nav nav-tabs" role="tablist" id="nav-tab-ul"> </ul>
				<!-- will be generated -->
				<div class="tab-content" id="nav-tabContent-rating">	</div>
				<div style="margin-top:0px;font-size:90%;text-align:center">Click <b>next</b> to answer all <b class="question_number"></b> questions, then submit your response.</div>
				<nav aria-label="..." id="navNextPre">
				  <ul class="pager">
					<li class="previous" id="prev-rating" onclick="showPreviousQuestionInRatingSection();"><a href="#navNextPre" class="page-link"  role="button" ><span aria-hidden="true">&larr;</span>Previous</a></li>
					<li class="next" onclick="showNextQuestionInRatingSection();"><a href="#navNextPre" class="page-link"  role="button">Next <span aria-hidden="true">&rarr;</span></a></li>
				  </ul>
				</nav>

			</div>
		</div>
</section>


<section class="container" id="thanks">
	<p>Thanks for your participation. Please perform more HITs from this group when they are available for you.</p>
</section>


<section class="container" id="max_allowed_HITs_reached" hidden>
	<p><h2>Well done! </h2> You performed the maximum number of HITs that you were allowed to.</p>

	<div class="alert alert-danger" role="alert">
		<img src="https://p808.s3.amazonaws.com/assets/img/attention.png" alt="attention">
			  <b>NOTE:</b> Performing more HITs
		than what is explained in the description is forbidden and leads ro rejection of all of your submissions.
			</div>

</section>